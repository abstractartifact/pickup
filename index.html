<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Pickup Lineup — FIFA ’98</title>
<style>
:root{
  --bg:#0b0f1a; --panel:#111a2c; --panel-2:#0e1626; --text:#f5f7ff; --muted:#9fb0d0;
  --accent:#ffd100; --accent2:#19b6ff; --accent3:#ff7a1a; --ok:#00e19b; --danger:#ff3b3b;
  --border:#1c2a44; --chipA:#1f3d77; --chipB:#4a1f6e;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  background:
    repeating-linear-gradient(135deg, rgba(255,209,0,.14) 0 12px, rgba(0,163,255,.14) 12px 24px),
    radial-gradient(1200px 600px at 110% -10%, rgba(0,163,255,.38), transparent 40%),
    radial-gradient(900px 500px at -10% 110%, rgba(255,107,0,.30), transparent 40%),
    var(--bg);
}
.wrap{max-width:1120px; margin:0 auto; padding:16px}
.card{ background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%); border:1px solid var(--border); border-radius:16px; padding:14px;
  box-shadow:0 10px 28px rgba(0,0,0,.35), 0 0 0 1px rgba(32,184,255,.12); }
.header{ position:relative; margin-bottom:14px; padding:16px 14px; border-radius:16px;
  background:linear-gradient(120deg, rgba(0,163,255,.45), rgba(255,209,0,.30) 60%, rgba(255,107,0,.22)), linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
  border:1px solid var(--border); overflow:hidden; }
.header::before{ content:""; position:absolute; inset:-20% -10% auto auto; transform:skewY(-12deg); width:60%; height:180%;
  background:linear-gradient(180deg, rgba(255,209,0,0), rgba(255,209,0,.18) 45%, rgba(255,209,0,0)),
             repeating-linear-gradient(-35deg, rgba(255,209,0,.55) 0 10px, rgba(0,163,255,.55) 10px 20px, rgba(255,107,0,.55) 20px 30px);
  mix-blend-mode:overlay; pointer-events:none; }
h1{ margin:0; font-size:22px; letter-spacing:.8px; text-transform:uppercase; text-shadow:0 2px 0 rgba(0,0,0,.4), 0 0 18px rgba(255,209,0,.35), 0 0 36px rgba(0,163,255,.25) }
.tagline{ color:var(--muted); font-size:13px }
.tabbar{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap }
.tab{ background:linear-gradient(180deg, #0e1526, #0b1220); color:#cbd8f4; border:1px solid var(--border); border-radius:12px; padding:10px 12px; cursor:pointer; min-height:40px; }
.tab.active{ color:#fff; border-color:#2b3d62; background:linear-gradient(180deg, #10203e, #0d1a33) }
.grid{ display:grid; gap:10px } .grid-3{ grid-template-columns:repeat(3,minmax(0,1fr)) } @media (max-width:760px){ .grid-3{ grid-template-columns:1fr } }
.row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
label{ font-size:12px; color:var(--muted) }
input, select{ width:100%; min-height:44px; padding:12px; color:#fff; background:#0b1220; border:1px solid var(--border); border-radius:12px; }
.btn{ min-height:40px; padding:10px 12px; color:#fff; background:linear-gradient(180deg, #122240, #0f1b33); border:1px solid #2b3d62; border-radius:12px; cursor:pointer; transition:transform .06s, box-shadow .06s; }
.btn:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,163,255,.5), 0 0 0 1px rgba(25,182,255,.35) }
.btn.gold{ background:linear-gradient(180deg, #ffd100, #caa800); border-color:#ffdf3a; color:#0c0c0c; font-weight:700; box-shadow:0 0 0 1px rgba(255,209,0,.35) }
.btn.blue{ background:linear-gradient(180deg, #1366a8, #0f4e7a); box-shadow:0 0 0 1px rgba(25,182,255,.35) }
.btn.red{ background:linear-gradient(180deg, #6a1010, #4f0c0c) }
.btn.small{ min-height:34px; padding:8px 10px; font-size:13px }
.pill{ display:inline-block; border:1px solid #3b5da3; background:#0f1738; color:#cbd8f4; border-radius:999px; padding:4px 10px; font-size:12px; box-shadow:inset 0 0 12px rgba(32,184,255,.15) }
.pill.A{ background:var(--chipA) } .pill.B{ background:var(--chipB) }
.split{ display:flex; align-items:center; justify-content:space-between; gap:8px }
.player{ display:flex; align-items:center; justify-content:space-between; gap:8px; background:#0b1326; border:1px solid var(--border); padding:10px; border-radius:12px }
.player.out{ opacity:.6; background:#140f16; border-color:#3b2a2a }
.muted{ color:var(--muted) }
.teams{ display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr)) } .teams.four{ grid-template-columns:repeat(4,minmax(0,1fr)) }
@media (max-width:900px){ .teams.four{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
.team-title{ display:flex; align-items:center; justify-content:space-between }
.kbd{ font-family:ui-monospace,SFMono-Regular,Menlo,monospace; background:#0b0e14; border:1px solid var(--border); padding:2px 8px; border-radius:8px; font-size:12px; color:#cbd8f4 }
hr{ border:none; height:1px; background:linear-gradient(90deg, transparent, #2b3d62, transparent); margin:12px 0 }
.section-title{ font-size:13px; letter-spacing:.2px; color:var(--muted); text-transform:uppercase }
.auth{ display:flex; gap:8px; align-items:center; flex-wrap:wrap } .auth input{ width:auto; min-width:240px }
.debug{ margin-top:12px; font-size:12px; background:#0b0e14; border:1px dashed #3b5da3; padding:8px; border-radius:10px; color:#cbd8f4; white-space:pre-wrap; display:block }
.select{ min-height:32px; padding:6px 8px; }
.small-note{ font-size:12px; color:var(--muted) }
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>if(!window.supabase){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js';document.head.appendChild(s);}</script>
</head>
<body>
<div class="wrap">
  <div class="header card">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap">
      <div>
        <h1>Pickup Lineup <span style="color:var(--accent)">’98</span></h1>
        <div class="tagline">No GKs · 2 teams until 20 active · 4 teams at 20+ (A→A/C, B→B/D)</div>
        <div class="tabbar">
          <button id="tabRoster" class="tab active">Roster</button>
          <button id="tabTeams" class="tab">Teams</button>
          <button id="tabAbout" class="tab">About</button>
        </div>
      </div>
      <div class="auth">
        <input id="email" placeholder="you@example.com" />
        <button type="button" class="btn small blue" id="sendMagic">Email me a sign-in link</button>
        <span class="muted" id="authStatus">Not signed in</span>
        <button class="btn small red" id="signOut" style="display:none">Sign out</button>
      </div>
    </div>
  </div>

  <!-- ROSTER -->
  <section id="panelRoster" class="card">
    <div class="split" style="margin-bottom:10px">
      <div class="muted" id="countsHint">Active 0 / Total 0</div>
      <div class="row">
        <button class="btn small blue" id="allInBtn">All active</button>
        <button class="btn small red" id="allOutBtn">All out</button>
      </div>
    </div>

    <div class="grid grid-3">
      <div><label for="name">Name</label><input id="name" placeholder="e.g., Sam" /></div>
      <div><label for="skill">Quality (1–5)</label>
        <select id="skill">
          <option value="1">1 · Beginner</option><option value="2">2</option><option value="3" selected>3 · Intermediate</option><option value="4">4</option><option value="5">5 · Advanced</option>
        </select>
      </div>
      <div><label for="position">Position</label>
        <select id="position"><option value="ANY" selected>ANY</option><option value="DEF">DEF</option><option value="MID">MID</option><option value="FWD">FWD</option></select>
      </div>
      <div><label for="stamina">Stamina (1–3)</label>
        <select id="stamina"><option value="1">1 · Low</option><option value="2" selected>2 · Medium</option><option value="3">3 · High</option></select>
      </div>
      <div style="align-self:end"><button class="btn gold" id="addBtn">Add player</button></div>
    </div>

    <hr />
    <div class="row" style="align-items:flex-start; gap:8px; flex-wrap:wrap">
      <button class="btn" id="exportTeamsBtn">Export teams (CSV)</button>
      <button class="btn" id="exportRosterBtn">Export roster (CSV)</button>
      <label class="btn" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer">
        <span>Import roster (CSV)</span><input type="file" id="importFile" accept=".csv" style="display:none" />
      </label>

      <div class="row" style="align-items:center">
        <label for="sortMode">Sort</label>
        <select id="sortMode">
          <option value="alpha_asc">Alpha A→Z</option>
          <option value="alpha_desc">Alpha Z→A</option>
          <option value="quality_desc" selected>Quality ↓</option>
          <option value="stamina_desc">Stamina ↓</option>
        </select>
      </div>

      <span class="pill" id="dbPill">DB: offline</span>
      <button class="btn blue" id="dbPushBtn" disabled>Sync local → DB</button>
      <button class="btn blue" id="dbPullBtn" disabled>Pull DB → local</button>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="split">
        <div>
          <div class="section-title">Link sharing</div>
          <div class="muted" id="shareStatus"></div>
        </div>
        <div class="row">
          <button class="btn small blue" id="makeLinkBtn">Make shareable link</button>
          <button class="btn small blue" id="copyLinkBtn">Copy link</button>
        </div>
      </div>
      <div id="debug" class="debug">Booting…</div>
    </div>

    <div id="rosterList" class="grid grid-3" style="margin-top:12px"></div>
  </section>

  <!-- TEAMS -->
  <section id="panelTeams" class="card" style="display:none">
    <div class="split">
      <div class="row" style="gap:12px">
        <span class="section-title">Teams from active players</span>
        <span class="pill A">A-side</span>
        <span class="pill B">B-side</span>
      </div>
      <div class="row">
        <button class="btn small blue" id="reshuffleTeamsBtn">Reshuffle</button>
        <span class="pill" id="overridesPill" title="Manual moves that stick across reshuffles">Manual moves: 0</span>
        <span class="pill" id="teamsCountPill">2 teams</span>
      </div>
    </div>
    <div class="small-note">Tip: use the dropdown next to any name to move them. A/C are the same side; B/D are the same side.</div>
    <div id="teamsWrap" class="teams" style="margin-top:12px"></div>
  </section>

  <!-- ABOUT -->
  <section id="panelAbout" class="card" style="display:none">
    <div class="section-title">How it balances</div>
    <ul>
      <li>Two teams for &lt;20 active; at 20+ it splits A→A/C and B→B/D (keeps A/B groups).</li>
      <li>Player attributes: <i>quality</i> (1–5), <i>position</i> (DEF/MID/FWD/ANY), <i>stamina</i> (1–3).</li>
    </ul>
  </section>
</div>

<script>
(function(){
  // ===== DEBUG =====
  var debugEl = document.getElementById('debug');
  function log(msg){ try{ debugEl.textContent += (debugEl.textContent? '\\n':'' ) + msg; console.log('[DEBUG]', msg); }catch(e){} }
  window.onerror = function(message, source, lineno, colno, error){ log('JS ERROR: '+message+' @'+lineno+':'+colno); };

  // ===== CONFIG (YOUR VALUES) =====
  var SUPABASE_URL  = "https://jkdvcxdagwpvlhcrbytl.supabase.co";
  var SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprZHZjeGRhZ3dwdmxoY3JieXRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MzY3MzYsImV4cCI6MjA3NTAxMjczNn0.T5pEYdmCzWKZbzRUgzj4tgQC2a1chjLNi1LyuXDdqco";
  var REDIRECT_URL  = "https://abstractartifact.github.io/pickup/index.html";

  // ===== INIT (sticky session) =====
  var supabase = null, currentUser = null, syncing = false;
  if (window.supabase && SUPABASE_URL.indexOf('http') === 0) {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession: true, autoRefreshToken: true, storage: window.localStorage }
    });
    log('Supabase client created (sticky session)');
  } else { log('DB not configured; local only'); }

  // Tabs
  function $(id){ return document.getElementById(id); }
  function showPanel(id, btn){
    $('panelRoster').style.display = (id==='panelRoster')?'block':'none';
    $('panelTeams') .style.display = (id==='panelTeams') ?'block':'none';
    $('panelAbout') .style.display = (id==='panelAbout') ?'block':'none';
    $('tabRoster').classList.remove('active'); $('tabTeams').classList.remove('active'); $('tabAbout').classList.remove('active');
    btn.classList.add('active');
  }
  $('tabRoster').addEventListener('click', function(){ showPanel('panelRoster', $('tabRoster')); log('Tab: Roster'); });
  $('tabTeams') .addEventListener('click', function(){ showPanel('panelTeams',  $('tabTeams' )); renderTeams(); log('Tab: Teams'); });
  $('tabAbout') .addEventListener('click', function(){ showPanel('panelAbout',  $('tabAbout' )); log('Tab: About'); });
  showPanel('panelRoster', $('tabRoster'));

  // ===== Storage & helpers =====
  var KEYS = {
    roster:"pl_roster_db_v2",
    abmap:"pl_abmap_db_v1",
    overrides:"pl_overrides_v1",
    lastTeams:"pl_last_teams_v1",   // NEW: last shown assignment
    seed:"pl_seed_v1"               // NEW: persistent shuffle seed
  };
  var seed = load(KEYS.seed, 0), sortMode = "quality_desc";
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
  function load(k,fb){ try{ var v=localStorage.getItem(k); return v? JSON.parse(v):fb; }catch(e){ return fb; } }
  function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, function(m){ return {"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#039;"}[m]; }); }
  function parseActive(v){ if(v==null||v==="") return true; var s=String(v).toLowerCase(); return ["1","true","yes","y","in","active"].indexOf(s)>=0; }
  function normalize(p){ return { id:p.id||uid(), name:p.name, skill:+p.skill||+p.quality||3, position:(p.position||'ANY'), stamina:Math.max(1,Math.min(3,+p.stamina||2)), active:(p.active!==false), side:p.side||null }; }

  var roster = load(KEYS.roster, []).map(normalize);
  var abMap  = load(KEYS.abmap, {});
  var overrides = load(KEYS.overrides, {});  // {playerId: "Team A"/"Team B"/"Team C"/"Team D"}

  function setOverridesPill(){ var n = Object.keys(overrides||{}).length; $('overridesPill').textContent = 'Manual moves: '+n; }

  // Link sharing
  function toCompact(){ return roster.map(function(p){ return [p.name, p.skill, p.position, p.stamina, p.active?1:0, abMap[p.id]||p.side||""]; }); }
  function fromCompact(arr){
    var out=[], sideByName={};
    (arr||[]).forEach(function(a){
      var n=a[0], s=a[1], po=a[2], st=a[3], a1=a[4], side=a[5];
      var pos = ["DEF","MID","FWD","ANY"].indexOf(String(po).toUpperCase())>=0 ? String(po).toUpperCase() : "ANY";
      out.push({id:uid(), name:n, skill:+s||3, position:pos, stamina:Math.max(1,Math.min(3,+st||2)), active:!!a1, side:side||null});
      if(side==="A"||side==="B") sideByName[n]=side;
    });
    var map={}; out.forEach(function(p){ if(sideByName[p.name]) map[p.id]=sideByName[p.name]; });
    return { roster:out, abMap:map };
  }
  function makeLink(){
    try{
      var payload={r:toCompact()};
      var encoded = encodeURIComponent(JSON.stringify(payload));
      var url = location.origin+location.pathname+'#r='+encoded;
      history.replaceState(null,'','#r='+encoded);
      $('shareStatus').textContent = 'Link updated ('+roster.length+' players)';
      log('Share link updated');
      return url;
    }catch(e){ log('Share link error: '+e.message); return ''; }
  }
  function tryLoadFromHash(){
    var m=(location.hash||'').match(/#r=([^&]+)/); if(!m) return false;
    try{
      var obj = JSON.parse(decodeURIComponent(m[1]));
      if(!obj || !obj.r || !obj.r.length) return false;
      var r=fromCompact(obj.r);
      roster=r.roster.map(normalize); abMap=r.abMap;
      save(KEYS.roster,roster); save(KEYS.abmap,abMap);
      $('shareStatus').textContent='Loaded roster from link ('+roster.length+' players)';
      log('Loaded roster from link');
      return true;
    }catch(e){ $('shareStatus').textContent='Invalid roster link'; log('Link decode error: '+e.message); return false; }
  }

  // Roster UI
  function updateCounts(){ var active=roster.filter(function(p){return p.active!==false;}).length; $('countsHint').textContent='Active '+active+' / Total '+roster.length; }
  function getSortedRoster(){
    var arr=roster.slice();
    function byName(a,b){ return a.name.localeCompare(b.name, undefined, {sensitivity:'base'}); }
    function byQuality(a,b){ return (b.skill - a.skill) || (b.stamina - a.stamina) || byName(a,b); }
    function byStamina(a,b){ return (b.stamina - a.stamina) || (b.skill - a.skill) || byName(a,b); }
    if(sortMode==='alpha_asc') arr.sort(byName);
    else if(sortMode==='alpha_desc') arr.sort(function(a,b){ return byName(b,a); });
    else if(sortMode==='stamina_desc') arr.sort(byStamina);
    else arr.sort(byQuality);
    return arr;
  }
  function renderRoster(){
    var root=$('rosterList'); root.innerHTML='';
    if(!roster.length){ root.innerHTML='<div class="muted">No players yet. Add or import a CSV — or open a share link.</div>'; return; }
    getSortedRoster().forEach(function(p){
      var div=document.createElement('div'); div.className='player'+(p.active===false?' out':'');
      div.innerHTML=
        '<div>'+
          '<div><b>'+escapeHtml(p.name)+'</b> '+(p.active===false?'<span class="pill">OUT</span>':'')+'</div>'+
          '<div class="muted" style="font-size:12px">'+p.position+' · Quality '+p.skill+' · Stamina '+p.stamina+'</div>'+
        '</div>'+
        '<div class="row">'+
          '<button class="btn small" data-act="toggle">'+(p.active!==false?'Set OUT':'Set IN')+'</button>'+
          '<button class="btn small" data-act="skp">Quality +</button>'+
          '<button class="btn small" data-act="skm">Quality −</button>'+
          '<button class="btn small" data-act="stp">Sta +</button>'+
          '<button class="btn small" data-act="stm">Sta −</button>'+
          '<button class="btn small red" data-act="del">Delete</button>'+
        '</div>';
      var btns = div.querySelectorAll('button');
      for(var i=0;i<btns.length;i++){
        btns[i].addEventListener('click', (function(btn){
          return function(){
            var act=btn.getAttribute('data-act');
            if(act==='del'){ delete abMap[p.id]; delete overrides[p.id]; roster=roster.filter(function(x){return x!==p;}); if(dbOnline()) dbDelete(p); }
            else if(act==='skp'){ p.skill=Math.min(5,p.skill+1); if(dbOnline()) dbUpsert(p); }
            else if(act==='skm'){ p.skill=Math.max(1,p.skill-1); if(dbOnline()) dbUpsert(p); }
            else if(act==='stp'){ p.stamina=Math.min(3,p.stamina+1); if(dbOnline()) dbUpsert(p); }
            else if(act==='stm'){ p.stamina=Math.max(1,p.stamina-1); if(dbOnline()) dbUpsert(p); }
            else if(act==='toggle'){ p.active=!(p.active!==false?true:false); if(dbOnline()) dbUpsert(p); }
            save(KEYS.roster,roster); save(KEYS.abmap,abMap); save(KEYS.overrides,overrides);
            renderRoster(); renderTeams(); updateCounts(); makeLink(); setOverridesPill();
          };
        })(btns[i]));
      }
      root.appendChild(div);
    });
  }

  // Team building
  function score(p){ return p.skill*10 + p.stamina; }
  function djb2(s){ var h=5381; for(var i=0;i<s.length;i++){ h=((h<<5)+h)+s.charCodeAt(i); h|=0; } return Math.abs(h); }
  function jitter(name, k, scale){ if(scale==null) scale=.49; var v = djb2(name+'#'+k)%1000/1000; return (v*2-1)*scale; }
  function sortWithJitter(list){
    return list.slice().sort(function(a,b){
      var sa=score(a)+jitter(a.name,seed,.49), sb=score(b)+jitter(b.name,seed,.49);
      return sb!==sa? sb-sa : a.name.localeCompare(b.name);
    });
  }
  function computeBalancedTeams(players, names){
    var T=names.map(function(n){ return { name:n, players:[], total:0, pos:{DEF:0,MID:0,FWD:0,ANY:0} }; });
    var totals={}; players.forEach(function(p){ totals[p.position]=(totals[p.position]||0)+1; });
    function target(k){ return Math.round((totals[k]||0)/names.length); }
    sortWithJitter(players).forEach(function(p){
      var pS=score(p), best=0, bestVal=Infinity;
      for(var i=0;i<T.length;i++){
        var t=T[i], sizePenalty=t.players.length*2, posShort=Math.max(0, target(p.position)-(t.pos[p.position]||0));
        var val=(t.total+pS)+sizePenalty - posShort*3 + jitter(p.name+':'+t.name,seed,.49);
        if(val<bestVal){ bestVal=val; best=i; }
      }
      var tt=T[best]; tt.players.push(p); tt.total+=pS; tt.pos[p.position]=(tt.pos[p.position]||0)+1;
    });
    T.forEach(function(t){
      t.avgSkill=t.players.length?(t.players.reduce(function(s,p){return s+p.skill;},0)/t.players.length):0;
      t.avgStamina=t.players.length?(t.players.reduce(function(s,p){return s+p.stamina;},0)/t.players.length):0;
    });
    return T;
  }
  function mapTeamAlias(name, available){
    if (available.length === 2) {
      if (name === 'Team C') return 'Team A';
      if (name === 'Team D') return 'Team B';
    }
    for (var i=0;i<available.length;i++){ if (available[i]===name) return name; }
    return available[0];
  }
  function applyOverrides(teams){
    var names = teams.map(function(t){return t.name;});
    var byName = {}; for (var i=0;i<teams.length;i++){ byName[teams[i].name]=teams[i]; }
    var owner = {};
    for (var i=0;i<teams.length;i++){
      var arr = teams[i].players;
      for (var j=0;j<arr.length;j++){ owner[arr[j].id] = teams[i].name; }
    }
    for (var pid in overrides){
      var want = mapTeamAlias(overrides[pid], names);
      var have = owner[pid];
      if (!want || !byName[want] || have===want) continue;
      var p=null, idx=-1, from=null;
      for (var i=0;i<teams.length;i++){
        var arr = teams[i].players;
        for (var j=0;j<arr.length;j++){
          if (arr[j].id === pid){ p = arr[j]; idx=j; from=teams[i]; break; }
        }
        if (p) break;
      }
      if (!p) continue;
      from.players.splice(idx,1);
      byName[want].players.push(p);
      var side = (want==='Team A'||want==='Team C') ? 'A' : 'B';
      p.side = side;
      abMap[pid] = side;
      save(KEYS.abmap, abMap);
      if (dbOnline()) dbUpsert(p);
    }
    for (var k=0;k<teams.length;k++){
      var t=teams[k];
      t.avgSkill=t.players.length?(t.players.reduce(function(s,p){return s+p.skill;},0)/t.players.length):0;
      t.avgStamina=t.players.length?(t.players.reduce(function(s,p){return s+p.stamina;},0)/t.players.length):0;
    }
    return teams;
  }
  function buildTeams(active){
    if(active.length===0) return [];
    if(active.length<20){ return applyOverrides(computeBalancedTeams(active,["Team A","Team B"])); }
    var A=[],B=[], sumA=0,sumB=0;
    active.forEach(function(p){
      var side=abMap[p.id]||p.side;
      if(side==='A'){A.push(p); sumA+=score(p);}
      else if(side==='B'){B.push(p); sumB+=score(p);}
      else { if(sumA<=sumB){ A.push(p); sumA+=score(p); abMap[p.id]='A'; } else { B.push(p); sumB+=score(p); abMap[p.id]='B'; } }
    });
    save(KEYS.abmap,abMap);
    var AC=computeBalancedTeams(A,["Team A","Team C"]);
    var BD=computeBalancedTeams(B,["Team B","Team D"]);
    return applyOverrides([AC[0],BD[0],AC[1],BD[1]]);
  }
  function renderTeams(){
    var active=roster.filter(function(p){return p.active!==false;});
    var teams=buildTeams(active);
    $('teamsCountPill').textContent = teams.length + ' team' + (teams.length>1?'s':'');
    $('teamsWrap').className='teams'+(teams.length===4?' four':'');
    $('teamsWrap').innerHTML='';
    var teamNames = teams.map(function(t){return t.name;});
    teams.forEach(function(t){
      var side=(t.name==='Team A'||t.name==='Team C')?'A':'B';
      var card=document.createElement('div'); card.className='card';
      card.innerHTML=
        '<div class="team-title">'+
          '<h3 style="margin:0">'+t.name+'</h3>'+
          '<span class="pill '+side+'">Players '+t.players.length+'</span>'+
        '</div>'+
        '<div class="muted" style="font-size:12px; margin-top:6px">Avg quality '+t.avgSkill.toFixed(2)+' · Avg stamina '+t.avgStamina.toFixed(2)+'</div>'+
        '<ul class="team-list" style="list-style:none; padding:0; margin:8px 0 0; display:grid; gap:6px"></ul>';
      var ul=card.querySelector('.team-list');
      t.players.forEach(function(p){
        var li=document.createElement('li'); li.className='player';
        var sel = document.createElement('select'); sel.className='select'; sel.setAttribute('aria-label','Move '+p.name+' to team');
        for (var i=0;i<teamNames.length;i++){
          var opt=document.createElement('option'); opt.value=teamNames[i]; opt.textContent=teamNames[i];
          if (teamNames[i]===t.name) opt.selected=true;
          sel.appendChild(opt);
        }
        sel.addEventListener('change', function(pid, select){
          return function(){
            overrides[pid] = select.value;
            save(KEYS.overrides, overrides);
            var side = (select.value==='Team A'||select.value==='Team C') ? 'A' : 'B';
            var rp = roster.find(function(x){return x.id===pid;});
            if (rp){ rp.side=side; abMap[pid]=side; save(KEYS.abmap,abMap); if(dbOnline()) dbUpsert(rp); }
            setOverridesPill();
            renderTeams();
          };
        }(p.id, sel));
        var left = document.createElement('div');
        left.innerHTML = '<span>'+escapeHtml(p.name)+'</span><span class="muted" style="font-size:12px"> '+p.position+' · Q'+p.skill+'/St'+p.stamina+'</span>';
        li.appendChild(left);
        li.appendChild(sel);
        ul.appendChild(li);
      });
      $('teamsWrap').appendChild(card);
    });

    // NEW: persist the last shown team assignment
    var last = {};
    teams.forEach(function(t){ t.players.forEach(function(p){ last[p.id] = t.name; }); });
    save(KEYS.lastTeams, last);
  }

  // CSV / Sort / Buttons
  function rowsToCSV(rows){ return rows.map(function(r){ return r.map(function(x){ return '"' + String(x).replace(/"/g,'""') + '"'; }).join(','); }).join('\n'); }
  function download(filename, text){ var blob=new Blob([text],{type:'text/csv;charset=utf-8;'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }

  $('addBtn').addEventListener('click', function(){
    var name=$('name').value.trim(); var skill=+$('skill').value; var position=$('position').value; var stamina=+$('stamina').value;
    if(!name) return; var p={id:uid(), name:name, skill:skill, position:position, stamina:stamina, active:true, side:null};
    roster.push(p); save(KEYS.roster,roster); $('name').value='';
    if(dbOnline()) dbUpsert(p);
    renderRoster(); renderTeams(); updateCounts(); makeLink();
  });
  $('allInBtn').addEventListener('click', function(){ roster.forEach(function(p){p.active=true;}); save(KEYS.roster,roster); if(dbOnline()) bulkUpsert(roster); renderRoster(); renderTeams(); updateCounts(); makeLink(); });
  $('allOutBtn').addEventListener('click', function(){ roster.forEach(function(p){p.active=false;}); save(KEYS.roster,roster); if(dbOnline()) bulkUpsert(roster); renderRoster(); renderTeams(); updateCounts(); makeLink(); });

  // NEW: persistent reseed
  function reseed(){
    seed = (seed * 1664525 + 1013904223) >>> 0;
    save(KEYS.seed, seed);
  }
  $('reshuffleTeamsBtn').addEventListener('click', function(){ reseed(); renderTeams(); });

  $('exportRosterBtn').addEventListener('click', function(){
    var rows=[["name","quality","position","stamina","active","side"]];
    roster.forEach(function(p){ rows.push([p.name,p.skill,p.position,p.stamina,p.active?1:0,p.side||""]); });
    download('roster.csv', rowsToCSV(rows));
  });
  $('exportTeamsBtn').addEventListener('click', function(){
    var active=roster.filter(function(p){return p.active!==false;}); var teams=buildTeams(active);
    var rows=[["Team","Player","Quality","Position","Stamina"]];
    teams.forEach(function(t){ t.players.forEach(function(p){ rows.push([t.name,p.name,p.skill,p.position,p.stamina]); }); });
    download('pickup_teams_'+teams.length+'t_'+active.length+'p.csv', rowsToCSV(rows));
  });
  $('importFile').addEventListener('change', function(e){
    var f=e.target.files && e.target.files[0]; if(!f) return;
    var reader=new FileReader();
    reader.onload=function(){
      try{
        var lines=String(reader.result||'').trim().split(/\r?\n/).filter(Boolean);
        var out=[];
        for(var i=0;i<lines.length;i++){
          var cols=lines[i].split(',').map(function(c){return c.trim();});
          if(cols[0].toLowerCase()==='name') continue;
          var nm=cols[0], skOrQ=cols[1], pos=cols[2], st=cols[3], act=cols[4], side=cols[5];
          if(!nm) continue;
          var position=['DEF','MID','FWD','ANY'].indexOf((pos||'ANY').toUpperCase())>=0 ? (pos||'ANY').toUpperCase() : 'ANY';
          var skill=Math.max(1,Math.min(5, Number(skOrQ)||3));
          var stamina=Math.max(1,Math.min(3, Number(st)||2));
          var active=parseActive(act);
          var sideN=(side==='A'||side==='B')? side : null;
          out.push({id:uid(), name:nm, skill:skill, position:position, stamina:stamina, active:active, side: sideN});
        }
        roster=out; abMap={}; overrides={}; save(KEYS.roster,roster); save(KEYS.abmap,abMap); save(KEYS.overrides,overrides);
        if(dbOnline()) bulkUpsert(roster);
        renderRoster(); renderTeams(); updateCounts(); makeLink(); setOverridesPill();
      }catch(err){ alert('Import failed. CSV should look like: name,quality,position,stamina[,active,side]'); log('import error: '+err.message); }
    };
    reader.readAsText(f); e.target.value='';
  });

  $('sortMode').addEventListener('change', function(e){ sortMode=e.target.value; renderRoster(); });
  $('makeLinkBtn').addEventListener('click', makeLink);
  $('copyLinkBtn').addEventListener('click', function(){ var url=makeLink(); try{ navigator.clipboard.writeText(url); $('shareStatus').textContent='Copied link'; } catch(e){ $('shareStatus').textContent=url; } });

  // ===== DB helpers =====
  function dbOnline(){ return !!(supabase && currentUser); }
  function setDbPill(){
    $('dbPill').textContent = dbOnline()? 'DB: online' : 'DB: offline';
    $('dbPushBtn').disabled = !dbOnline();
    $('dbPullBtn').disabled = !dbOnline();
  }
  function rowFromPlayer(p){
    return { id:p.id, user_id: currentUser && currentUser.id ? currentUser.id : null,
             name:p.name, quality:p.skill, position:p.position, stamina:p.stamina, active:p.active, side:p.side||null };
  }
  function playerFromRow(r){
    return normalize({ id:r.id, name:r.name, skill:r.quality, position:r.position, stamina:r.stamina, active:r.active, side:r.side });
  }
  function dbUpsert(p){
    if(!dbOnline() || syncing) return Promise.resolve();
    return supabase.from('players').upsert(rowFromPlayer(p)).select('id').single().then(function(r){
      if(r.error){ log('upsert error: '+r.error.message); }
    });
  }
  function bulkUpsert(list){
    if(!dbOnline() || syncing || !list || !list.length) return Promise.resolve();
    var rows=list.map(rowFromPlayer);
    return supabase.from('players').upsert(rows).select('id').then(function(r){
      if(r.error){ log('bulk upsert error: '+r.error.message); }
      else { log('bulk upsert ok: '+rows.length+' rows'); }
    });
  }
  function dbDelete(p){
    if(!dbOnline() || syncing) return Promise.resolve();
    return supabase.from('players').delete().match({ id:p.id, user_id: currentUser.id }).then(function(r){
      if(r.error){ log('delete error: '+r.error.message); }
    });
  }
  function dbPull(){
    if(!supabase || !currentUser) return Promise.resolve(false);
    syncing = true;
    return supabase.from('players').select('*').eq('user_id', currentUser.id).order('name', { ascending: true }).then(function(r){
      syncing = false;
      if(r.error){ log('pull error: '+r.error.message); return false; }
      var data=r.data||[];
      roster = data.map(playerFromRow);
      abMap = {}; roster.forEach(function(p){ if(p.side==='A'||p.side==='B') abMap[p.id]=p.side; });
      overrides = {}; // pull resets manual moves (local only)
      save(KEYS.roster,roster); save(KEYS.abmap,abMap); save(KEYS.overrides,overrides);
      renderRoster(); renderTeams(); updateCounts(); makeLink(); setDbPill(); setOverridesPill();
      log('pulled '+data.length+' rows from DB');
      return true;
    });
  }
  $('dbPushBtn').addEventListener('click', function(){ if(dbOnline()) bulkUpsert(roster); });
  $('dbPullBtn').addEventListener('click', function(){ if(dbOnline()) dbPull(); });

  // ===== Auth wiring (sticky restore + magic link) =====
  function setAuthUI(){ $('authStatus').textContent = currentUser ? 'Signed in' : 'Not signed in'; $('signOut').style.display = currentUser ? 'inline-flex' : 'none'; setDbPill(); }
  if (supabase){
    supabase.auth.getSession().then(function(res){
      var session = res && res.data ? res.data.session : null;
      currentUser = session && session.user ? session.user : null;
      setAuthUI();
      if(currentUser){ dbPull(); }
      log(currentUser ? 'Session restored' : 'No saved session');
    });
    supabase.auth.onAuthStateChange(function(event, session){
      log('auth state: '+event);
      currentUser = (session && session.user) ? session.user : null;
      setAuthUI();
      if(currentUser){ dbPull(); }
    });
    $('signOut').addEventListener('click', function(){ supabase.auth.signOut(); });
    $('sendMagic').addEventListener('click', function () {
      try {
        var email = $('email').value.trim();
        if (!email) { alert('Enter your email first.'); return; }
        $('sendMagic').disabled = true; $('sendMagic').textContent = 'Sending…'; $('authStatus').textContent = 'Sending magic link…';
        supabase.auth.signInWithOtp({ email: email, options: { emailRedirectTo: REDIRECT_URL } }).then(function(r){
          if (r && r.error){ log('signInWithOtp error: '+r.error.message); $('authStatus').textContent = 'Failed to send link'; }
          else { log('OTP request sent OK'); $('authStatus').textContent = 'Check your email for the sign-in link'; }
          $('sendMagic').disabled = false; $('sendMagic').textContent = 'Email me a sign-in link';
        }).catch(function(e){
          log('SendMagic exception: '+e.message); $('authStatus').textContent = 'Error sending link';
          $('sendMagic').disabled = false; $('sendMagic').textContent = 'Email me a sign-in link';
        });
      } catch (e) {
        log('SendMagic fatal: '+e.message);
        $('authStatus').textContent = 'Error sending link';
        $('sendMagic').disabled = false; $('sendMagic').textContent = 'Email me a sign-in link';
      }
    });
  }

  // ===== Boot =====
  var loaded = tryLoadFromHash();

  // NEW: restore last shown teams as overrides for current players
  var savedLast = load(KEYS.lastTeams, {});
  if (savedLast && typeof savedLast === 'object') {
    var ids = new Set((roster||[]).map(function(p){return p.id;}));
    Object.keys(savedLast).forEach(function(pid){
      if (ids.has(pid)) overrides[pid] = savedLast[pid];
    });
    save(KEYS.overrides, overrides);
  }

  renderRoster(); renderTeams(); updateCounts(); setOverridesPill();
  if(!loaded) $('shareStatus').textContent='No share link detected — using local roster';
  setAuthUI();
  log('Boot complete');

  // Exchange code after magic link
  try{
    var urlStr = window.location.href;
    var hasCode = (urlStr.indexOf('code=') >= 0);
    if (hasCode && supabase) {
      supabase.auth.exchangeCodeForSession(urlStr).then(function(res){
        if(res && res.error){ log('exchange error: ' + res.error.message); }
        history.replaceState({}, document.title, window.location.origin + window.location.pathname);
        log('exchanged code for session');
        supabase.auth.getSession().then(function(obj){
          var session = obj && obj.data ? obj.data.session : null;
          currentUser = session && session.user ? session.user : null;
          setAuthUI();
          if(currentUser){ dbPull(); }
        });
      });
    }
  }catch(e){ log('bootstrap exchange error: '+e.message); }
})();
</script>
</body>
</html>
